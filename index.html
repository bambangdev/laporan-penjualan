<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Laporan - infinithree.id</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border-top-color: #EC4899;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            color: #4b5563; /* gray-600 */
        }
        .sidebar-link:hover {
            background-color: #fce7f3; /* pink-100 */
            color: #be185d; /* pink-700 */
        }
        .sidebar-link.active {
            background-color: #db2777; /* pink-600 */
            color: white;
            font-weight: 600;
        }
        .sidebar-link svg {
            margin-right: 0.75rem;
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .stat-card {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Mobile sidebar transition */
        .sidebar-mobile-open {
            transform: translateX(0);
        }
        /* Style untuk tombol pagination disabled */
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loginSection" class="flex items-center justify-center h-screen">
        <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-lg text-center mx-4">
            <h1 class="text-2xl font-bold text-gray-800">infinithree.id</h1>
            <p class="text-gray-500 mb-6">Masukkan PIN untuk melanjutkan</p>
            <div id="pin-inputs" class="flex justify-center space-x-3 mb-4">
                <input type="password" maxlength="1" class="w-12 h-14 text-center text-2xl font-semibold border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                <input type="password" maxlength="1" class="w-12 h-14 text-center text-2xl font-semibold border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                <input type="password" maxlength="1" class="w-12 h-14 text-center text-2xl font-semibold border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                <input type="password" maxlength="1" class="w-12 h-14 text-center text-2xl font-semibold border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
            </div>
            <p id="pinError" class="text-red-500 text-sm h-4"></p>
        </div>
    </div>
    
    <div id="salesReportPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-lg text-center mx-4">
            <h2 class="text-xl font-bold text-gray-800">Akses Terbatas</h2>
            <p class="text-gray-500 mb-6 mt-1">Masukkan kata sandi untuk melihat laporan penjualan.</p>
            <form id="salesReportPasswordForm">
                <input type="password" id="salesReportPasswordInput" class="w-full px-4 py-2 text-center border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" placeholder="••••••••••">
                <p id="salesReportPasswordError" class="text-red-500 text-sm h-4 mt-2"></p>
                <div class="flex space-x-4 mt-6">
                    <button type="button" id="cancelSalesReport" class="w-full py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Batal</button>
                    <button type="submit" class="w-full py-2 px-4 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700">Buka</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editRowPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center">
        <div class="w-full max-w-sm p-8 bg-white rounded-xl shadow-lg text-center mx-4">
            <h2 class="text-xl font-bold text-gray-800">Edit Data Transaksi</h2>
            <p class="text-gray-500 mb-6 mt-1">Masukkan PIN untuk mengedit data ini.</p>
            <form id="editRowPasswordForm">
                <input type="password" id="editRowPasswordInput" class="w-full px-4 py-2 text-center border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500" placeholder="•••••">
                <p id="editRowPasswordError" class="text-red-500 text-sm h-4 mt-2"></p>
                <div class="flex space-x-4 mt-6">
                    <button type="button" id="cancelEditRow" class="w-full py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Batal</button>
                    <button type="submit" class="w-full py-2 px-4 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700">Verifikasi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="relative min-h-screen lg:flex">
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

            <aside id="sidebar" class="fixed inset-y-0 left-0 bg-white shadow-md w-64 z-30 transform -translate-x-full transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0">
                <div class="flex items-center justify-between p-4 border-b">
                    <h2 class="text-xl font-bold text-pink-600">infinithree.id</h2>
                    <button id="close-sidebar-btn" class="text-gray-500 hover:text-gray-800 lg:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <nav class="p-4 space-y-2">
                    <a href="#dashboard" class="sidebar-link active" data-page="dashboardPage">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                    <a href="#inputPenjualan" class="sidebar-link" data-page="inputPenjualanPage">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Input Penjualan
                    </a>
                    <a href="#inputReturn" class="sidebar-link" data-page="inputReturnPage">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l-3 3m3-3l3-3m-3 3h6a4 4 0 014 4v1m-6 0h6m-6 0H6a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v1"></path></svg>
                        Input Return
                    </a>
                     <a href="#inputTreatment" class="sidebar-link" data-page="inputTreatmentPage">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.293 2.293a1 1 0 010 1.414L10 16l-4 1 1-4 9.293-9.293a1 1 0 011.414 0z"></path></svg>
                        Input Treatment
                    </a>
                    <a href="#customerReport" class="sidebar-link" data-page="customerReportPage">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Customer Report
                    </a>
                     <a href="#salesReport" class="sidebar-link" data-page="salesReportPage">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Sales Report
                    </a>
                </nav>
            </aside>

            <main class="flex-1 lg:p-8 p-4 w-full">
                 <header class="flex items-center justify-between lg:hidden mb-4">
                    <button id="open-sidebar-btn" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h2 class="text-lg font-bold text-pink-600">infinithree.id</h2>
                </header>
                
                <div id="dashboardPage" class="page active">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
                    <div id="dashboardContent">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 border rounded-lg bg-gray-50">
                             <input type="search" id="dashboardSearchCustomer" placeholder="Cari Nama Customer..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                             <select id="dashboardFilterShift" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">Semua Shift</option></select>
                             <select id="dashboardFilterHost" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">Semua Host</option></select>
                             <select id="dashboardFilterAdmin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">Semua Admin</option></select>
                             <select id="dashboardFilterTransactionType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                                <option value="">Semua Jenis Transaksi</option>
                                <option value="Penjualan">Penjualan</option>
                                <option value="Return">Return</option>
                                <option value="Treatment">Treatment</option>
                             </select>
                             <div class="col-span-1 sm:col-span-2 lg:col-span-4">
                                <input type="text" id="dashboardDateRangePicker" placeholder="Pilih rentang tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                             </div>
                        </div>

                         <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="stat-card"><p class="text-sm text-gray-500">Total PCS Penjualan</p><p id="statPcsPenjualan" class="text-2xl font-bold text-gray-900">0</p></div>
                            <div class="stat-card"><p class="text-sm text-gray-500">Total Omzet Penjualan</p><p id="statOmzetPenjualan" class="text-2xl font-bold text-green-600">Rp 0</p></div>
                            <div class="stat-card"><p class="text-sm text-gray-500">Total PCS Return</p><p id="statPcsReturn" class="text-2xl font-bold text-gray-900">0</p></div>
                            <div class="stat-card"><p class="text-sm text-gray-500">Total Omzet Return</p><p id="statOmzetReturn" class="text-2xl font-bold text-red-600">Rp 0</p></div>
                        </div>
                        
                        <div class="mt-8">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Transaksi</h3>
                            <div class="flex justify-end mb-4">
                                <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-9.293a1 1 0 011.414 0L10 9.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd"></path><path fill-rule="evenodd" d="M9 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                                    Export Excel
                                </button>
                            </div>

                            <div id="dashboardTableContainer" class="table-responsive">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Host</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PCS</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Omzet</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Transaksi</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PCS Treatment</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="dashboardTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                            <div class="flex justify-between items-center mt-4">
                                <button id="prevPageBtn" class="pagination-btn bg-pink-500 hover:bg-pink-600 text-white py-2 px-4 rounded-lg">Sebelumnya</button>
                                <span class="text-gray-700">Halaman <span id="currentPageSpan">1</span> dari <span id="totalPagesSpan">1</span></span>
                                <button id="nextPageBtn" class="pagination-btn bg-pink-500 hover:bg-pink-600 text-white py-2 px-4 rounded-lg">Berikutnya</button>
                            </div>
                            <div id="editTransactionModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
                                <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4 flex flex-col max-h-[90vh]">
                                    <h2 class="text-2xl font-bold text-gray-800 p-8 pb-4">Edit Data Transaksi</h2>
                                    
                                    <div class="px-8 pb-4 overflow-y-auto flex-grow">
                                        <form id="editTransactionForm" novalidate class="space-y-4">
                                            <input type="hidden" id="editRowIndex">
                                            <input type="hidden" id="editOriginalTimestamp">
                                            
                                            <div class="space-y-4"> 
                                                <div><label for="editTransactionType" class="block text-sm font-medium text-gray-700 mb-1">Jenis Transaksi</label><input type="text" id="editTransactionType" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100"></div>
                                                <div><label for="editShift" class="block text-sm font-medium text-gray-700 mb-1">Shift</label><select id="editShift" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">-- Pilih Shift --</option><option value="Shift Pagi">Shift Pagi</option><option value="Shift Siang">Shift Siang</option></select></div>
                                                <div><label for="editHost" class="block text-sm font-medium text-gray-700 mb-1">Nama Host</label><select id="editHost" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">-- Pilih Host --</option></select></div>
                                                <div id="editBackupHostContainer" class="hidden"><label for="editBackupHost" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Host Backup</label><input type="text" id="editBackupHost" placeholder="Ketik nama host pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                                                <div><label for="editAdmin" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label><select id="editAdmin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">-- Pilih Admin --</option></select></div>
                                                <div id="editBackupAdminContainer" class="hidden"><label for="editBackupAdmin" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Admin Backup</label><input type="text" id="editBackupAdmin" placeholder="Ketik nama admin pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                                                <div><label for="editCustomer" class="block text-sm font-medium text-gray-700 mb-1">Nama Customer</label><input type="text" id="editCustomer" placeholder="Ketik nama customer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                                                <div><label for="editPcs" class="block text-sm font-medium text-gray-700 mb-1">Total Pcs</label><input type="number" id="editPcs" placeholder="Contoh: 50" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                                                <div><label for="editOmzet" class="block text-sm font-medium text-gray-700 mb-1">Total Omzet (Rp)</label><input type="text" id="editOmzet" placeholder="Contoh: 1.500.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                                                <div><label for="editOrangTreatment" class="block text-sm font-medium text-gray-700 mb-1">Orang Treatment</label><select id="editOrangTreatment" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">-- Pilih Nama --</option></select></div>
                                                <div id="editBackupTreatmentContainer" class="hidden"><label for="editBackupOrangTreatment" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Pengganti</label><input type="text" id="editBackupOrangTreatment" placeholder="Ketik nama pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                                                <div><label for="editPcsTreatment" class="block text-sm font-medium text-gray-700 mb-1">PCS Treatment</label><input type="number" id="editPcsTreatment" placeholder="Contoh: 35" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <div class="p-8 pt-4 bg-white border-t border-gray-200">
                                        <div class="flex space-x-4">
                                            <button type="button" id="cancelEditTransaction" class="w-full py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">Batal</button>
                                            <button type="submit" form="editTransactionForm" id="saveEditTransaction" class="w-full py-2 px-4 bg-pink-600 text-white font-semibold rounded-lg hover:bg-pink-700 flex items-center justify-center"><span>Simpan Perubahan</span><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div></button>
                                        </div>
                                        <p id="editTransactionStatus" class="mt-4 text-center text-sm h-4"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="inputPenjualanPage" class="page">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Input Laporan Penjualan</h1>
                     <form id="penjualanForm" novalidate class="max-w-md mx-auto p-6 bg-white rounded-lg shadow">
                        <div class="space-y-4">
                            <div><label for="penjualanShift" class="block text-sm font-medium text-gray-700 mb-1">Shift</label><select id="penjualanShift" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="" disabled selected>-- Pilih Shift --</option><option value="Shift Pagi">Shift Pagi</option><option value="Shift Siang">Shift Siang</option></select></div>
                            <div><label for="penjualanHost" class="block text-sm font-medium text-gray-700 mb-1">Nama Host</label><select id="penjualanHost" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="" disabled selected>-- Pilih Host --</option></select></div>
                            <div id="penjualanBackupHostContainer" class="hidden"><label for="penjualanBackupHost" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Host Backup</label><input type="text" id="penjualanBackupHost" placeholder="Ketik nama host pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="penjualanAdmin" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label><select id="penjualanAdmin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="" disabled selected>-- Pilih Admin --</option></select></div>
                            <div id="penjualanBackupAdminContainer" class="hidden"><label for="penjualanBackupAdmin" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Admin Backup</label><input type="text" id="penjualanBackupAdmin" placeholder="Ketik nama admin pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="penjualanCustomer" class="block text-sm font-medium text-gray-700 mb-1">Nama Customer</label><input type="text" id="penjualanCustomer" required placeholder="Ketik nama customer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="penjualanPcs" class="block text-sm font-medium text-gray-700 mb-1">Total Pcs</label><input type="number" id="penjualanPcs" required placeholder="Contoh: 50" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="penjualanOmzet" class="block text-sm font-medium text-gray-700 mb-1">Total Omzet (Rp)</label><input type="text" id="penjualanOmzet" required placeholder="Contoh: 1.500.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                        </div>
                        <button type="submit" id="penjualanSubmitBtn" class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition duration-150 ease-in-out flex items-center justify-center mt-6"><span>Kirim Penjualan</span><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div></button>
                        <p id="penjualanStatus" class="mt-4 text-center text-sm h-4"></p>
                    </form>
                </div>

                <div id="inputReturnPage" class="page">
                     <h1 class="text-3xl font-bold text-gray-800 mb-6">Input Laporan Return</h1>
                     <form id="returnForm" novalidate class="max-w-md mx-auto p-6 bg-white rounded-lg shadow">
                        <div class="space-y-4">
                            <div><label for="returnHost" class="block text-sm font-medium text-gray-700 mb-1">Nama Host</label><select id="returnHost" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="" disabled selected>-- Pilih Host --</option></select></div>
                            <div id="returnBackupHostContainer" class="hidden"><label for="returnBackupHost" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Host Backup</label><input type="text" id="returnBackupHost" placeholder="Ketik nama host pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="returnAdmin" class="block text-sm font-medium text-gray-700 mb-1">Nama Admin</label><select id="returnAdmin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="">-- Pilih Admin --</option></select></div>
                            <div id="returnBackupAdminContainer" class="hidden"><label for="returnBackupAdmin" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Admin Backup</label><input type="text" id="returnBackupAdmin" placeholder="Ketik nama admin pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="returnCustomer" class="block text-sm font-medium text-gray-700 mb-1">Nama Customer</label><input type="text" id="returnCustomer" required placeholder="Ketik nama customer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="returnPcs" class="block text-sm font-medium text-gray-700 mb-1">Total Pcs</label><input type="number" id="returnPcs" required placeholder="Contoh: 5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="returnOmzet" class="block text-sm font-medium text-gray-700 mb-1">Total Omzet (Rp)</label><input type="text" id="returnOmzet" required placeholder="Contoh: 150.000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                        </div>
                        <button type="submit" id="returnSubmitBtn" class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition duration-150 ease-in-out flex items-center justify-center mt-6"><span>Kirim Return</span><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div></button>
                        <p id="returnStatus" class="mt-4 text-center text-sm h-4"></p>
                    </form>
                </div>
                
                 <div id="inputTreatmentPage" class="page">
                     <h1 class="text-3xl font-bold text-gray-800 mb-6">Input Data Treatment</h1>
                     <form id="treatmentForm" novalidate class="max-w-md mx-auto p-6 bg-white rounded-lg shadow">
                        <div class="space-y-4">
                            <div><label for="treatmentPerson" class="block text-sm font-medium text-gray-700 mb-1">Nama Orang Treatment</label><select id="treatmentPerson" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"><option value="" disabled selected>-- Pilih Nama --</option></select></div>
                             <div id="treatmentBackupContainer" class="hidden"><label for="treatmentBackupPerson" class="block text-sm font-medium text-gray-700 mb-1">Isi Nama Pengganti</label><input type="text" id="treatmentBackupPerson" placeholder="Ketik nama pengganti" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                            <div><label for="treatmentPcs" class="block text-sm font-medium text-gray-700 mb-1">Jumlah PCS di-Treatment</label><input type="number" id="treatmentPcs" required placeholder="Contoh: 35" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500"></div>
                        </div>
                        <button type="submit" id="treatmentSubmitBtn" class="w-full bg-pink-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition duration-150 ease-in-out flex items-center justify-center mt-6"><span>Kirim Data Treatment</span><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div></button>
                        <p id="treatmentStatus" class="mt-4 text-center text-sm h-4"></p>
                    </form>
                </div>

                <div id="customerReportPage" class="page">
                     <h1 class="text-3xl font-bold text-gray-800 mb-6">Laporan Customer</h1>
                      <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <label for="customerReportDateRangePicker" class="block text-sm font-medium text-gray-700 mb-1">Pilih Rentang Tanggal</label>
                        <input type="text" id="customerReportDateRangePicker" placeholder="Filter data berdasarkan tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="stat-card">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Top Customer (Pembelian Terbanyak)</h4>
                            <p class="text-2xl font-bold text-pink-600" id="topBuyerName">-</p>
                            <div class="mt-2 text-gray-600">
                                <p>Total PCS: <span id="topBuyerPcs" class="font-medium">0</span></p>
                                <p>Total Omzet: <span id="topBuyerOmzet" class="font-medium">Rp 0</span></p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Top Customer (Return Terbanyak)</h4>
                            <p class="text-2xl font-bold text-red-600" id="topReturnerName">-</p>
                             <div class="mt-2 text-gray-600">
                                <p>Total PCS: <span id="topReturnerPcs" class="font-medium">0</span></p>
                                <p>Total Omzet: <span id="topReturnerOmzet" class="font-medium">Rp 0</span></p>
                            </div>
                        </div>
                     </div>
                </div>

                <div id="salesReportPage" class="page">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Sales Report (Bonus)</h1>
                     <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                        <label for="salesReportDateRangePicker" class="block text-sm font-medium text-gray-700 mb-1">Pilih Rentang Tanggal</label>
                        <input type="text" id="salesReportDateRangePicker" placeholder="Filter data berdasarkan tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
                    </div>

                    <div id="salesReportInsights" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6">
                        <div class="stat-card">
                            <p class="text-sm text-gray-500">Net Omzet</p>
                            <p id="salesReportNetOmzet" class="text-2xl font-bold text-blue-600">Rp 0</p>
                        </div>
                        <div class="stat-card">
                            <p class="text-sm text-gray-500">Rasio Return (%)</p>
                            <p id="salesReportReturnRatio" class="text-2xl font-bold text-red-600">0.00%</p>
                        </div>
                         <div class="stat-card">
                            <p class="text-sm text-gray-500">Total Customer Unik</p>
                            <p id="salesReportUniqueCustomers" class="text-2xl font-bold text-purple-600">0</p>
                        </div>
                        <div class="stat-card">
                            <p class="text-sm text-gray-500">Total Customer Repeat</p>
                            <p id="salesReportRepeatCustomers" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Estimasi Gaji Host</h4>
                            <div class="table-responsive border rounded-lg">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Hari Unik</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Gaji Pokok</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Total Gaji</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesReportHostSalaryTable" class="divide-y divide-gray-200">
                                        <tr><td colspan="4" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Estimasi Gaji Admin</h4>
                            <div class="table-responsive border rounded-lg">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Hari Unik</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Gaji Pokok</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Total Gaji</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesReportAdminSalaryTable" class="divide-y divide-gray-200">
                                        <tr><td colspan="4" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">Estimasi Gaji Treatment</h4>
                            <div class="table-responsive border rounded-lg">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Hari Unik</th>
                                            <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Gaji Pokok</th>
                                        </tr>
                                    </thead>
                                    <tbody id="salesReportTreatmentSalaryTable" class="divide-y divide-gray-200">
                                        <tr><td colspan="3" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>


                    <div class="bg-white p-6 rounded-lg shadow-md mb-6" style="height: 400px;">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Tren Omzet Penjualan Bulanan</h3>
                        <canvas id="monthlySalesChart"></canvas>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                         <h3 class="text-lg font-semibold text-gray-800 mb-4">Top Host Berdasarkan Omzet Penjualan</h3>
                         <div class="table-responsive border rounded-lg">
                             <table class="min-w-full bg-white">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Host</th>
                                         <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Total Omzet</th>
                                         <th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Total PCS</th>
                                     </tr>
                                 </thead>
                                 <tbody id="salesReportTopHostTable" class="divide-y divide-gray-200">
                                     <tr><td colspan="3" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>
                                 </tbody>
                             </table>
                         </div>
                    </div>


                    <div id="salesReportScoreboard">
                         <h3 class="text-lg font-semibold text-gray-800 mb-4">Scoreboard Estimasi Bonus Harian</h3>
                         <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                             <div>
                                 <h4 class="font-semibold text-gray-700 mb-2">Estimasi Bonus Host</h4>
                                 <div class="table-responsive border rounded-lg"><table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">PCS</th><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Bonus</th></tr></thead><tbody id="salesReportHostScoreboardBody" class="divide-y divide-gray-200"></tbody></table></div>
                             </div>
                             <div>
                                 <h4 class="font-semibold text-gray-700 mb-2">Estimasi Bonus Admin</h4>
                                 <div class="table-responsive border rounded-lg"><table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">PCS</th><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Bonus</th></tr></thead><tbody id="salesReportAdminScoreboardBody" class="divide-y divide-gray-200"></tbody></table></div>
                             </div>
                             <div>
                                 <h4 class="font-semibold text-gray-700 mb-2">Estimasi Bonus Treatment</h4>
                                 <div class="table-responsive border rounded-lg"><table class="min-w-full bg-white"><thead class="bg-gray-50"><tr><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Nama</th><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">PCS</th><th class="py-2 px-3 text-left text-xs font-medium text-gray-500 uppercase">Bonus</th></tr></thead><tbody id="salesReportTreatmentScoreboardBody" class="divide-y divide-gray-200"></tbody></table></div>
                             </div>
                         </div>
                    </div>
                </div>
                
                 <div id="pageLoader" class="hidden justify-center items-center h-40"><div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>
                <p id="pageError" class="text-center text-red-500 hidden"></p>

            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/moment/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
    // --- APP STATE & CONFIG ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxzpSVOHsYuDXUoJqHJ4mi2bHiHVT7tqSgD1Q6iq2RKHhwIqszVCfczZUMrNB7zzoFn/exec';
    const CORRECT_PIN = '7501';
    const SALES_REPORT_PASSWORD = 'kuyangora666';
    const EDIT_PIN = '69960';
    const hostList = ['wafa', 'debi', 'bunga'];
    const adminList = ['Bunga', 'Teh Ros'];
    const treatmentPersonList = ['Bunda', 'Resin'];
    let allData = [];
    let isDataFetched = false;
    let dashboardDatePicker, customerDatePicker, salesReportDatePicker;
    let currentRowToEdit = null;
    let monthlySalesChartInstance = null;

    // --- Pagination variables for Dashboard Table ---
    let filteredDashboardData = [];
    let currentPage = 1;
    const rowsPerPage = 30;

    // --- DOM ELEMENTS ---
    const loginSection = document.getElementById('loginSection');
    const mainApp = document.getElementById('mainApp');
    const pinInputs = document.querySelectorAll('#pin-inputs input');
    const pinError = document.getElementById('pinError');
    const sidebar = document.getElementById('sidebar');
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const pages = document.querySelectorAll('.page');
    const pageLoader = document.getElementById('pageLoader');
    const pageError = document.getElementById('pageError');
    const openSidebarBtn = document.getElementById('open-sidebar-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const salesReportPasswordModal = document.getElementById('salesReportPasswordModal');
    const salesReportPasswordForm = document.getElementById('salesReportPasswordForm');
    const salesReportPasswordInput = document.getElementById('salesReportPasswordInput');
    const salesReportPasswordError = document.getElementById('salesReportPasswordError');
    const cancelSalesReportBtn = document.getElementById('cancelSalesReport');

    const editRowPasswordModal = document.getElementById('editRowPasswordModal');
    const editRowPasswordForm = document.getElementById('editRowPasswordForm');
    const editRowPasswordInput = document.getElementById('editRowPasswordInput');
    const editRowPasswordError = document.getElementById('editRowPasswordError');
    const cancelEditRowBtn = document.getElementById('cancelEditRow');

    const editTransactionModal = document.getElementById('editTransactionModal');
    const editTransactionForm = document.getElementById('editTransactionForm');
    const editRowIndexInput = document.getElementById('editRowIndex');
    const editOriginalTimestampInput = document.getElementById('editOriginalTimestamp');
    const editTransactionTypeInput = document.getElementById('editTransactionType');
    const editShiftInput = document.getElementById('editShift');
    const editHostInput = document.getElementById('editHost');
    const editBackupHostContainer = document.getElementById('editBackupHostContainer');
    const editBackupHostInput = document.getElementById('editBackupHost');
    const editAdminInput = document.getElementById('editAdmin');
    const editBackupAdminContainer = document.getElementById('editBackupAdminContainer');
    const editBackupAdminInput = document.getElementById('editBackupAdmin');
    const editCustomerInput = document.getElementById('editCustomer');
    const editPcsInput = document.getElementById('editPcs');
    const editOmzetInput = document.getElementById('editOmzet');
    const editOrangTreatmentInput = document.getElementById('editOrangTreatment');
    const editBackupTreatmentContainer = document.getElementById('editBackupTreatmentContainer');
    const editBackupOrangTreatmentInput = document.getElementById('editBackupOrangTreatment');
    const editPcsTreatmentInput = document.getElementById('editPcsTreatment');
    const cancelEditTransactionBtn = document.getElementById('cancelEditTransaction');
    const saveEditTransactionBtn = document.getElementById('saveEditTransaction');
    const editTransactionStatus = document.getElementById('editTransactionStatus');

    const salesReportNetOmzet = document.getElementById('salesReportNetOmzet');
    const salesReportReturnRatio = document.getElementById('salesReportReturnRatio');
    const salesReportUniqueCustomers = document.getElementById('salesReportUniqueCustomers');
    const salesReportRepeatCustomers = document.getElementById('salesReportRepeatCustomers');
    const salesReportTopHostTable = document.getElementById('salesReportTopHostTable');
    // Estimasi Gaji Table Elements
    const salesReportHostSalaryTable = document.getElementById('salesReportHostSalaryTable');
    const salesReportAdminSalaryTable = document.getElementById('salesReportAdminSalaryTable');
    const salesReportTreatmentSalaryTable = document.getElementById('salesReportTreatmentSalaryTable');


    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const currentPageSpan = document.getElementById('currentPageSpan');
    const totalPagesSpan = document.getElementById('totalPagesSpan');

    // NEW: Export Excel Button Element
    const exportExcelBtn = document.getElementById('exportExcelBtn');


    // --- HELPER FUNCTIONS ---
    const parseCurrency = (value) => Number(String(value).replace(/[^0-9]/g, '')) || 0;
    const formatCurrency = (value) => `Rp ${new Intl.NumberFormat('id-ID').format(value || 0)}`;

    function populateDropdown(selectElement, listItems, includeBackup = true) {
        const firstOption = selectElement.options[0];
        selectElement.innerHTML = '';
        if (firstOption) selectElement.appendChild(firstOption);

        listItems.forEach(item => selectElement.add(new Option(item, item)));
        if(includeBackup) selectElement.add(new Option('Backup (Isi Manual)', 'Backup'));
    }

    // Fungsi untuk mengecek duplikasi customer di hari yang sama
    function checkDuplicateCustomerToday(customerName, transactionType) {
        const today = moment().startOf('day');
        
        const transactionsToday = allData.filter(row => {
            const rowDate = moment(row['Tanggal Input']);
            return rowDate.isSame(today, 'day') && 
                   String(row['Nama Customer'] || '').toLowerCase() === customerName.toLowerCase() &&
                   row['Jenis Transaksi'] === transactionType;
        });
        
        return transactionsToday.length > 0;
    }

    // --- PAGE & NAVIGATION LOGIC ---
    function closeSidebar() {
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
    }

    function switchPage(pageId) {
        pages.forEach(page => page.classList.toggle('active', page.id === pageId));
        sidebarLinks.forEach(link => link.classList.toggle('active', link.dataset.page === pageId));
        if (window.innerWidth < 1024) {
            closeSidebar();
        }
        if (['dashboardPage', 'customerReportPage', 'salesReportPage'].includes(pageId)) {
            isDataFetched = false; 
            fetchData();
        }
    }
    
    // --- LOGIN & PASSWORD LOGIC ---
    pinInputs.forEach((input, index) => {
        input.addEventListener('keydown', (e) => {
            if (e.key === "Backspace" && !input.value && index > 0) pinInputs[index - 1].focus();
        });
        input.addEventListener('input', () => {
            if (input.value && index < pinInputs.length - 1) pinInputs[index + 1].focus();
            const enteredPin = Array.from(pinInputs).map(i => i.value).join('');
            if (enteredPin.length === 4) {
                if (enteredPin === CORRECT_PIN) {
                    loginSection.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    switchPage('dashboardPage');
                } else {
                    pinError.textContent = 'PIN salah, coba lagi.';
                    pinInputs.forEach(i => i.value = '');
                    pinInputs[0].focus();
                }
            } else {
                 pinError.textContent = '';
            }
        });
    });

    salesReportPasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (salesReportPasswordInput.value === SALES_REPORT_PASSWORD) {
            salesReportPasswordModal.classList.add('hidden');
            salesReportPasswordModal.classList.remove('flex');
            switchPage('salesReportPage');
            salesReportPasswordInput.value = '';
            salesReportPasswordError.textContent = '';
        } else {
            salesReportPasswordError.textContent = 'Kata sandi salah.';
        }
    });

    cancelSalesReportBtn.addEventListener('click', () => {
        salesReportPasswordModal.classList.add('hidden');
        salesReportPasswordModal.classList.remove('flex');
        salesReportPasswordInput.value = '';
        salesReportPasswordError.textContent = '';
    });

    editRowPasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (editRowPasswordInput.value === EDIT_PIN) {
            editRowPasswordModal.classList.add('hidden');
            editRowPasswordModal.classList.remove('flex');
            editRowPasswordInput.value = '';
            editRowPasswordError.textContent = '';
            
            populateEditModal(currentRowToEdit);
            editTransactionModal.classList.remove('hidden');
            editTransactionModal.classList.add('flex');
        } else {
            editRowPasswordError.textContent = 'PIN salah.';
        }
    });

    cancelEditRowBtn.addEventListener('click', () => {
        editRowPasswordModal.classList.add('hidden');
        editRowPasswordModal.classList.remove('flex');
        editRowPasswordInput.value = '';
        editRowPasswordError.textContent = '';
        currentRowToEdit = null;
    });

    cancelEditTransactionBtn.addEventListener('click', () => {
        editTransactionModal.classList.add('hidden');
        editTransactionModal.classList.remove('flex');
        editTransactionForm.reset();
        editTransactionStatus.textContent = '';
        currentRowToEdit = null;
        editBackupHostContainer.classList.add('hidden');
        editBackupAdminContainer.classList.add('hidden');
        editBackupTreatmentContainer.classList.add('hidden');
    });

    // --- DATA FETCHING & RENDERING LOGIC ---
    async function fetchData() {
        if (isDataFetched) {
            if (document.getElementById('salesReportPage').classList.contains('active')) {
                applySalesReportFilters();
            } else if (document.getElementById('dashboardPage').classList.contains('active')) {
                applyFilters();
            } else if (document.getElementById('customerReportPage').classList.contains('active')) {
                applyCustomerReportFilters();
            }
            return;
        }
        pageLoader.classList.remove('hidden');
        pageError.classList.add('hidden');
        
        try {
            const response = await fetch(SCRIPT_URL);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            allData = result.data.sort((a, b) => {
                const dateA = a['Tanggal Input'] ? new Date(a['Tanggal Input']) : new Date(0);
                const dateB = b['Tanggal Input'] ? new Date(b['Tanggal Input']) : new Date(0);
                return dateB - dateA;
            });
            isDataFetched = true;
            populateFilters(); 
            
            if (document.getElementById('salesReportPage').classList.contains('active')) {
                applySalesReportFilters();
            } else if (document.getElementById('dashboardPage').classList.contains('active')) {
                applyFilters();
            } else if (document.getElementById('customerReportPage').classList.contains('active')) {
                applyCustomerReportFilters();
            }

        } catch (error) {
            pageError.textContent = `Gagal memuat data: ${error.message}.`;
            pageError.classList.remove('hidden');
        } finally {
            pageLoader.classList.add('hidden');
        }
    }

    function applyFilters() { // This function is for the Dashboard page
        const dashboardSearchCustomer = document.getElementById('dashboardSearchCustomer');
        const dashboardFilterShift = document.getElementById('dashboardFilterShift');
        const dashboardFilterHost = document.getElementById('dashboardFilterHost');
        const dashboardFilterAdmin = document.getElementById('dashboardFilterAdmin');
        const dashboardFilterTransactionType = document.getElementById('dashboardFilterTransactionType'); // NEW filter
        
        const searchTerm = dashboardSearchCustomer.value.toLowerCase();
        const selectedShift = dashboardFilterShift.value;
        const selectedHost = dashboardFilterHost.value;
        const selectedAdmin = dashboardFilterAdmin.value;
        const selectedTransactionType = dashboardFilterTransactionType.value; // NEW filter value
        const startDate = dashboardDatePicker.getStartDate()?.toJSDate();
        const endDate = dashboardDatePicker.getEndDate()?.toJSDate();
        if(startDate) startDate.setHours(0,0,0,0);
        if(endDate) endDate.setHours(23,59,59,999);

        // Filter data berdasarkan kriteria
        filteredDashboardData = allData.filter(row => {
            const rowDate = row['Tanggal Input'] ? new Date(row['Tanggal Input']) : null;
            const customerMatch = String(row['Nama Customer'] || '').toLowerCase().includes(searchTerm);
            const shiftMatch = selectedShift ? row.Shift === selectedShift : true;
            const hostMatch = selectedHost ? row['Nama Host'] === selectedHost : true;
            const adminMatch = selectedAdmin ? row['Nama Admin'] === selectedAdmin : true;
            const transactionTypeMatch = selectedTransactionType ? row['Jenis Transaksi'] === selectedTransactionType : true; // NEW filter logic
            const dateMatch = (!startDate || (rowDate && rowDate >= startDate)) && (!endDate || (rowDate && rowDate <= endDate));
            return customerMatch && shiftMatch && hostMatch && adminMatch && transactionTypeMatch && dateMatch; // Update filter conditions
        });
        
        // Reset halaman saat filter berubah
        currentPage = 1;
        
        calculateAndRenderStats(filteredDashboardData);
        renderDashboardTable(); // Panggil renderDashboardTable tanpa parameter, gunakan filteredDashboardData global
    }
    
    function calculateAndRenderStats(data) {
        const penjualanData = data.filter(r => r['Jenis Transaksi'] === 'Penjualan');
        const returnData = data.filter(r => r['Jenis Transaksi'] === 'Return');

        const statPcsPenjualan = document.getElementById('statPcsPenjualan');
        const statOmzetPenjualan = document.getElementById('statOmzetPenjualan');
        const statPcsReturn = document.getElementById('statPcsReturn');
        const statOmzetReturn = document.getElementById('statOmzetReturn');
        
        statPcsPenjualan.textContent = penjualanData.reduce((s, r) => s + Number(r['Total Pcs'] || 0), 0).toLocaleString('id-ID');
        statOmzetPenjualan.textContent = formatCurrency(penjualanData.reduce((s, r) => s + Number(r['Total Omzet'] || 0), 0));
        statPcsReturn.textContent = returnData.reduce((s, r) => s + Number(r['Total Pcs'] || 0), 0).toLocaleString('id-ID');
        statOmzetReturn.textContent = formatCurrency(returnData.reduce((s, r) => s + Number(r['Total Omzet'] || 0), 0));
    }
    
    function calculateAndRenderScoreboard(data, hostTbodyId, adminTbodyId, treatmentTbodyId) {
        const getJustDate = (isoString) => isoString ? isoString.split('T')[0] : null;

        const processPerformance = (sourceData, groupByField, pcsField, omzetField, bonusRate, bonusType, target) => {
            const performance = {};
            const salesByPerson = sourceData.reduce((acc, row) => {
                const key = row[groupByField];
                if (key) (acc[key] = acc[key] || []).push(row);
                return acc;
            }, {});

            for (const name in salesByPerson) {
                const personSales = salesByPerson[name];
                const totalPcs = personSales.reduce((s, r) => s + Number(r[pcsField] || 0), 0);
                let totalBonus = 0;

                const salesByDay = personSales.reduce((acc, row) => {
                    const day = getJustDate(row['Tanggal Input']);
                    if (day) {
                        (acc[day] = acc[day] || []).push(row);
                    }
                    return acc;
                }, {});

                for (const date in salesByDay) {
                    const dailyPcs = salesByDay[date].reduce((s, r) => s + Number(r[pcsField] || 0), 0);
                    if (dailyPcs >= target) {
                         if (bonusType === 'percentage') {
                            const dailyOmzet = salesByDay[date].reduce((s, r) => s + parseCurrency(r[omzetField] || 0), 0);
                            totalBonus += dailyOmzet * bonusRate;
                         } else if (bonusType === 'fixed') {
                            totalBonus += bonusRate;
                         }
                    }
                }
                performance[name] = { totalPcs, totalBonus };
            }
            return performance;
        };
        
        const renderScoreboardTable = (tbody, performanceData) => {
            tbody.innerHTML = '';
            const sortedNames = Object.keys(performanceData).sort((a,b) => performanceData[b].totalBonus - performanceData[a].totalBonus);
            if (sortedNames.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>`;
                 return;
            }
            sortedNames.forEach(name => {
                const perf = performanceData[name];
                tbody.innerHTML += `<tr><td class="py-2 px-3 text-sm font-medium text-gray-900">${name}</td><td class="py-2 px-3 text-sm text-gray-500">${perf.totalPcs.toLocaleString('id-ID')}</td><td class="py-2 px-3 text-sm font-semibold text-pink-600">${formatCurrency(perf.totalBonus)}</td></tr>`;
            });
        };
        
        const salesData = data.filter(r => r['Jenis Transaksi'] === 'Penjualan');
        const treatmentData = data.filter(r => r['Jenis Transaksi'] === 'Treatment');
        
        renderScoreboardTable(document.getElementById(hostTbodyId), processPerformance(salesData, 'Nama Host', 'Total Pcs', 'Total Omzet', 0.03, 'percentage', 40));
        renderScoreboardTable(document.getElementById(adminTbodyId), processPerformance(salesData, 'Nama Admin', 'Total Pcs', 'Total Omzet', 0.01, 'percentage', 40));
        renderScoreboardTable(document.getElementById(treatmentTbodyId), processPerformance(treatmentData, 'Orang Treatment', 'PCS Treatment', null, 2500, 'fixed', 30));
    }

    // Modifikasi renderDashboardTable untuk pagination
    function renderDashboardTable() {
        const tbody = document.getElementById('dashboardTableBody');
        tbody.innerHTML = '';

        const totalRows = filteredDashboardData.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        // Tentukan data untuk halaman saat ini
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, totalRows);
        const paginatedData = filteredDashboardData.slice(startIndex, endIndex);

        if (paginatedData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="10" class="text-center py-10 text-gray-500">Tidak ada data yang cocok.</td></tr>`;
        } else {
            paginatedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.dataset.rowData = JSON.stringify(row); 

                const tanggalFormatted = row['Tanggal Input'] ? new Date(row['Tanggal Input']).toLocaleDateString('id-ID', {day:'2-digit',month:'short',year:'numeric'}) : '-';

                tr.innerHTML = `
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-900">${tanggalFormatted}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${row['Nama Customer'] || '-'}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${row['Shift'] || '-'}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${row['Nama Host'] || '-'}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${row['Nama Admin'] || '-'}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${Number(row['Total Pcs'] || 0).toLocaleString('id-ID')}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(row['Total Omzet'])}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${row['Jenis Transaksi']}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-sm text-gray-500">${Number(row['PCS Treatment'] || 0).toLocaleString('id-ID')}</td>
                    <td class="py-4 px-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 edit-row-btn" data-row-index="${row.rowIndex}">Edit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Update pagination controls
        currentPageSpan.textContent = currentPage;
        totalPagesSpan.textContent = totalPages;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;

        document.querySelectorAll('.edit-row-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const tr = e.target.closest('tr');
                currentRowToEdit = JSON.parse(tr.dataset.rowData);
                editRowPasswordModal.classList.remove('hidden');
                editRowPasswordModal.classList.add('flex');
                editRowPasswordInput.focus();
            });
        });
    }

    // Fungsi untuk mengubah halaman pagination
    function changePage(direction) {
        if (direction === 'prev' && currentPage > 1) {
            currentPage--;
        } else if (direction === 'next' && currentPage < Math.ceil(filteredDashboardData.length / rowsPerPage)) {
            currentPage++;
        }
        renderDashboardTable(); // Render ulang tabel dengan halaman baru
    }

    function populateEditModal(data) {
        editRowIndexInput.value = data.rowIndex;
        editOriginalTimestampInput.value = data['Tanggal Input'];
        editTransactionTypeInput.value = data['Jenis Transaksi'] || '';
        editShiftInput.value = data.Shift || '';

        populateDropdown(editHostInput, hostList);
        editHostInput.value = data['Nama Host'] || '';
        if (!hostList.includes(data['Nama Host']) && data['Nama Host']) {
            editHostInput.value = 'Backup';
            editBackupHostContainer.classList.remove('hidden');
            editBackupHostInput.value = data['Nama Host'];
        } else {
            editBackupHostContainer.classList.add('hidden');
            editBackupHostInput.value = '';
        }

        populateDropdown(editAdminInput, adminList);
        editAdminInput.value = data['Nama Admin'] || '';
        if (!adminList.includes(data['Nama Admin']) && data['Nama Admin']) {
            editAdminInput.value = 'Backup';
            editBackupAdminContainer.classList.remove('hidden');
            editBackupAdminInput.value = data['Nama Admin'];
        } else {
            editBackupAdminContainer.classList.add('hidden');
            editBackupAdminInput.value = '';
        }

        editCustomerInput.value = data['Nama Customer'] || '';
        editPcsInput.value = data['Total Pcs'] || '';
        editOmzetInput.value = formatCurrency(data['Total Omzet']);
        
        populateDropdown(editOrangTreatmentInput, treatmentPersonList);
        editOrangTreatmentInput.value = data['Orang Treatment'] || '';
        if (!treatmentPersonList.includes(data['Orang Treatment']) && data['Orang Treatment']) {
            editOrangTreatmentInput.value = 'Backup';
            editBackupTreatmentContainer.classList.remove('hidden');
            editBackupOrangTreatmentInput.value = data['Orang Treatment'];
        } else {
            editBackupTreatmentContainer.classList.add('hidden');
            editBackupOrangTreatmentInput.value = '';
        }
        editPcsTreatmentInput.value = data['PCS Treatment'] || '';

        editHostInput.onchange = () => { editBackupHostContainer.classList.toggle('hidden', editHostInput.value !== 'Backup'); };
        editAdminInput.onchange = () => { editBackupAdminContainer.classList.toggle('hidden', editAdminInput.value !== 'Backup'); };
        editOrangTreatmentInput.onchange = () => { editBackupTreatmentContainer.classList.toggle('hidden', editOrangTreatmentInput.value !== 'Backup'); };

        editOmzetInput.oninput = (e) => { e.target.value = formatCurrency(parseCurrency(e.target.value)); };
    }

    editTransactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = saveEditTransactionBtn;
        const btnText = submitBtn.querySelector('span');
        const loader = submitBtn.querySelector('.loader');
        
        btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

        const finalHost = editHostInput.value === 'Backup' ? editBackupHostInput.value.trim() : editHostInput.value;
        const finalAdmin = editAdminInput.value === 'Backup' ? editBackupAdminInput.value.trim() : editAdminInput.value;
        const finalTreatment = editOrangTreatmentInput.value === 'Backup' ? editBackupOrangTreatmentInput.value.trim() : editOrangTreatmentInput.value;

        const omzetValue = parseCurrency(editOmzetInput.value);

        const formData = {
            action: 'edit',
            rowIndex: editRowIndexInput.value,
            timestamp: editOriginalTimestampInput.value,
            transactionType: editTransactionTypeInput.value || '',
            shift: editShiftInput.value || '',
            host: finalHost || '',
            adminName: finalAdmin || '',
            customerName: editCustomerInput.value || '',
            totalPcs: editPcsInput.value || '',
            totalOmzet: omzetValue || '',
            orangTreatment: finalTreatment || '',
            pcsTreatment: editPcsTreatmentInput.value || '',
        };
        
        try {
            const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(formData) });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            editTransactionStatus.textContent = `Data berhasil diperbarui!`;
            editTransactionStatus.className = 'mt-4 text-center text-sm h-4 text-green-600';
            isDataFetched = false;
            await fetchData();
            setTimeout(() => {
                editTransactionModal.classList.add('hidden');
                editTransactionModal.classList.remove('flex');
                editTransactionForm.reset();
                editTransactionStatus.textContent = '';
                currentRowToEdit = null;
                editBackupHostContainer.classList.add('hidden');
                editBackupAdminContainer.classList.add('hidden');
                editBackupTreatmentContainer.classList.add('hidden');
            }, 1500);
        } catch (error) {
            editTransactionStatus.textContent = `Error: ${error.message}`;
            editTransactionStatus.className = 'mt-4 text-center text-sm h-4 text-red-600';
        } finally {
            btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
        }
    });

    function applyCustomerReportFilters() {
        if (!isDataFetched) return;
        const startDate = customerDatePicker.getStartDate()?.toJSDate();
        const endDate = customerDatePicker.getEndDate()?.toJSDate();
        if(startDate) startDate.setHours(0,0,0,0);
        if(endDate) endDate.setHours(23,59,59,999);
        
        const filteredData = allData.filter(row => {
             const rowDate = row['Tanggal Input'] ? new Date(row['Tanggal Input']) : null;
             return (!startDate || (rowDate && rowDate >= startDate)) && (!endDate || (rowDate && rowDate <= endDate));
        });
        calculateAndRenderCustomerReport(filteredData);
    }

    function calculateAndRenderCustomerReport(data) {
        const topBuyerEl = { name: document.getElementById('topBuyerName'), pcs: document.getElementById('topBuyerPcs'), omzet: document.getElementById('topBuyerOmzet') };
        const topReturnerEl = { name: document.getElementById('topReturnerName'), pcs: document.getElementById('topReturnerPcs'), omzet: document.getElementById('topReturnerOmzet') };
        
        const getTopCustomer = (sourceData, pcsField, omzetField) => {
            if (sourceData.length === 0) return null;
            const customerData = sourceData.reduce((acc, row) => {
                const name = row['Nama Customer'];
                if(!name || name === '-') return acc;
                acc[name] = acc[name] || { pcs: 0, omzet: 0 };
                acc[name].pcs += Number(row[pcsField] || 0);
                acc[name].omzet += parseCurrency(row[omzetField] || 0);
                return acc;
            }, {});
            const topCustomerName = Object.keys(customerData).sort((a,b) => customerData[b].omzet - customerData[a].omzet)[0];
            return topCustomerName ? { name: topCustomerName, ...customerData[topCustomerName] } : null;
        };
        
        const topBuyer = getTopCustomer(data.filter(r => r['Jenis Transaksi'] === 'Penjualan'), 'Total Pcs', 'Total Omzet');
        const topReturner = getTopCustomer(data.filter(r => r['Jenis Transaksi'] === 'Return'), 'Total Pcs', 'Total Omzet');

        const renderTopCustomer = (elements, data) => {
            if (data) {
                elements.name.textContent = data.name;
                elements.pcs.textContent = data.pcs.toLocaleString('id-ID');
                elements.omzet.textContent = formatCurrency(data.omzet);
            } else {
                elements.name.textContent = '-';
                elements.pcs.textContent = '0';
                elements.omzet.textContent = 'Rp 0';
            }
        };
        renderTopCustomer(topBuyerEl, topBuyer);
        renderTopCustomer(topReturnerEl, topReturner);
    }

    // Sales Report Specific Calculations and Rendering
    function applySalesReportFilters() {
        if (!isDataFetched) return;
        const startDate = salesReportDatePicker.getStartDate()?.toJSDate();
        const endDate = salesReportDatePicker.getEndDate()?.toJSDate();
        if(startDate) startDate.setHours(0,0,0,0);
        if(endDate) endDate.setHours(23,59,59,999);
        
        const filteredData = allData.filter(row => {
             const rowDate = row['Tanggal Input'] ? new Date(row['Tanggal Input']) : null;
             return (!startDate || (rowDate && rowDate >= startDate)) && (!endDate || (rowDate && rowDate <= endDate));
        });

        calculateAndRenderScoreboard(filteredData, 'salesReportHostScoreboardBody', 'salesReportAdminScoreboardBody', 'salesReportTreatmentScoreboardBody');

        const penjualanData = filteredData.filter(r => r['Jenis Transaksi'] === 'Penjualan');
        const returnData = filteredData.filter(r => r['Jenis Transaksi'] === 'Return');
        const treatmentData = filteredData.filter(r => r['Jenis Transaksi'] === 'Treatment');

        // 1. Net Omzet
        const totalOmzetPenjualan = penjualanData.reduce((s, r) => s + parseCurrency(r['Total Omzet'] || 0), 0);
        const totalOmzetReturn = returnData.reduce((s, r) => s + parseCurrency(r['Total Omzet'] || 0), 0);
        const netOmzet = totalOmzetPenjualan - totalOmzetReturn;
        salesReportNetOmzet.textContent = formatCurrency(netOmzet);

        // 2. Rasio Return
        const returnRatio = totalOmzetPenjualan > 0 ? (totalOmzetReturn / totalOmzetPenjualan) * 100 : 0;
        salesReportReturnRatio.textContent = `${returnRatio.toFixed(2)}%`;

        // 3. Total Customer Unik
        const customerPurchaseCounts = penjualanData.reduce((acc, row) => {
            const customerName = String(row['Nama Customer'] || '').trim();
            if (customerName) {
                acc[customerName] = (acc[customerName] || 0) + 1;
            }
            return acc;
        }, {});

        const uniqueCustomers = Object.keys(customerPurchaseCounts).length;
        salesReportUniqueCustomers.textContent = uniqueCustomers.toLocaleString('id-ID');

        // Total Customer Repeat
        let repeatCustomers = 0;
        for (const customer in customerPurchaseCounts) {
            if (customerPurchaseCounts[customer] > 1) {
                repeatCustomers++;
            }
        }
        salesReportRepeatCustomers.textContent = repeatCustomers.toLocaleString('id-ID');

        // Estimasi Gaji Calculation and Rendering for tables
        // Helper untuk menghitung hari unik per orang
        const getPersonUniqueDays = (dataArray, personField) => {
            const personDays = {};
            dataArray.forEach(row => {
                const date = moment(row['Tanggal Input']);
                const person = String(row[personField] || '').trim();
                if (date.isValid() && person) {
                    personDays[person] = personDays[person] || new Set();
                    personDays[person].add(date.format('YYYY-MM-DD'));
                }
            });
            return personDays; // Mengembalikan map nama -> Set hari unik
        };

        // Helper untuk mendapatkan total bonus per orang (dari fungsi calculateAndRenderScoreboard)
        const getPersonBonus = (sourceData, groupByField, pcsField, omzetField, bonusRate, bonusType, target) => {
            const performance = {};
            const getJustDate = (isoString) => isoString ? isoString.split('T')[0] : null;

            sourceData.forEach(row => { // Loop through all sales/treatment data
                const name = String(row[groupByField] || '').trim();
                const day = getJustDate(row['Tanggal Input']);
                
                if (name && day) {
                    performance[name] = performance[name] || { totalPcsDaily: {}, totalOmzetDaily: {} }; // Init if not exists
                    performance[name].totalPcsDaily[day] = (performance[name].totalPcsDaily[day] || 0) + Number(row[pcsField] || 0);
                    if (omzetField) { // Only add omzet for percentage-based bonuses
                        performance[name].totalOmzetDaily[day] = (performance[name].totalOmzetDaily[day] || 0) + parseCurrency(row[omzetField] || 0);
                    }
                }
            });

            // Calculate total bonus based on daily performance
            for (const name in performance) {
                let currentPersonTotalBonus = 0;
                for (const day in performance[name].totalPcsDaily) {
                    const dailyPcs = performance[name].totalPcsDaily[day];
                    if (dailyPcs >= target) {
                        if (bonusType === 'percentage') {
                            const dailyOmzet = performance[name].totalOmzetDaily[day] || 0;
                            currentPersonTotalBonus += dailyOmzet * bonusRate;
                        } else if (bonusType === 'fixed') {
                            currentPersonTotalBonus += bonusRate;
                        }
                    }
                }
                performance[name].totalBonus = currentPersonTotalBonus;
            }
            // Return only { name: { totalBonus: value } }
            return Object.keys(performance).reduce((acc, name) => {
                acc[name] = { totalBonus: performance[name].totalBonus };
                return acc;
            }, {});
        };


        const hostDailyData = getPersonUniqueDays(penjualanData, 'Nama Host');
        const adminDailyData = getPersonUniqueDays(penjualanData, 'Nama Admin');
        const treatmentDailyData = getPersonUniqueDays(treatmentData, 'Orang Treatment'); // Gaji treatment berdasarkan hari unik

        const hostBonusData = getPersonBonus(penjualanData, 'Nama Host', 'Total Pcs', 'Total Omzet', 0.03, 'percentage', 40);
        const adminBonusData = getPersonBonus(penjualanData, 'Nama Admin', 'Total Pcs', 'Total Omzet', 0.01, 'percentage', 40);

        const hostSalaryRate = 80000;
        const adminSalaryRate = 60000;
        const treatmentDailyRate = 12500; // Tarif gaji treatment per hari unik


        const renderSalaryTable = (tbodyElement, dailyDataMap, bonusDataMap, rate, isTreatment = false) => {
            tbodyElement.innerHTML = '';
            const allNames = new Set([...Object.keys(dailyDataMap), ...Object.keys(bonusDataMap)]);
            const sortedNames = Array.from(allNames).sort();

            if (sortedNames.length === 0) {
                if (isTreatment) {
                    tbodyElement.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>`;
                } else {
                    tbodyElement.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>`;
                }
                return;
            }

            sortedNames.forEach(name => {
                const uniqueDays = dailyDataMap[name] ? dailyDataMap[name].size : 0;
                const basicSalary = uniqueDays * rate;
                const totalBonus = bonusDataMap[name] ? bonusDataMap[name].totalBonus : 0; // Get bonus
                const totalSalary = basicSalary + totalBonus; // Total gaji = basic + bonus
                
                const tr = document.createElement('tr');
                if (isTreatment) {
                    tr.innerHTML = `
                        <td class="py-2 px-3 text-sm font-medium text-gray-900">${name}</td>
                        <td class="py-2 px-3 text-sm text-gray-500">${uniqueDays.toLocaleString('id-ID')} Hari</td>
                        <td class="py-2 px-3 text-sm font-semibold text-gray-800">${formatCurrency(basicSalary)}</td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td class="py-2 px-3 text-sm font-medium text-gray-900">${name}</td>
                        <td class="py-2 px-3 text-sm text-gray-500">${uniqueDays.toLocaleString('id-ID')} Hari</td>
                        <td class="py-2 px-3 text-sm text-gray-500">${formatCurrency(basicSalary)}</td>
                        <td class="py-2 px-3 text-sm font-semibold text-green-600">${formatCurrency(totalSalary)}</td>
                    `;
                }
                tbodyElement.appendChild(tr);
            });
        };

        renderSalaryTable(salesReportHostSalaryTable, hostDailyData, hostBonusData, hostSalaryRate, false);
        renderSalaryTable(salesReportAdminSalaryTable, adminDailyData, adminBonusData, adminSalaryRate, false);
        renderSalaryTable(salesReportTreatmentSalaryTable, treatmentDailyData, {}, treatmentDailyRate, true);


        // 4. Tren Penjualan Bulanan (Chart.js)
        renderMonthlySalesChart(penjualanData);

        // 5. Top Host Berdasarkan Omzet Penjualan
        renderTopHostSalesTable(penjualanData);
    }

    // Function to render Monthly Sales Chart
    function renderMonthlySalesChart(data) {
        const monthlyData = data.reduce((acc, row) => {
            const date = moment(row['Tanggal Input']);
            if (date.isValid()) {
                const monthYear = date.format('YYYY-MM');
                acc[monthYear] = (acc[monthYear] || 0) + parseCurrency(row['Total Omzet'] || 0);
            }
            return acc;
        }, {});

        const sortedMonths = Object.keys(monthlyData).sort();
        const labels = sortedMonths.map(monthYear => moment(monthYear, 'YYYY-MM').format('MMM YY'));
        const omzetData = sortedMonths.map(month => monthlyData[month]);

        const ctx = document.getElementById('monthlySalesChart').getContext('2d');

        if (monthlySalesChartInstance) {
            monthlySalesChartInstance.destroy();
        }

        monthlySalesChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Omzet Penjualan',
                    data: omzetData,
                    borderColor: '#EC4899',
                    backgroundColor: 'rgba(236, 72, 153, 0.2)',
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Omzet (Rp)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Bulan'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Function to render Top Host Sales Table
    function renderTopHostSalesTable(data) {
        const hostSales = data.reduce((acc, row) => {
            const hostName = row['Nama Host'] || 'Unknown';
            acc[hostName] = acc[hostName] || { omzet: 0, pcs: 0 };
            acc[hostName].omzet += parseCurrency(row['Total Omzet'] || 0);
            acc[hostName].pcs += Number(row['Total Pcs'] || 0);
            return acc;
        }, {});

        const sortedHosts = Object.keys(hostSales).sort((a, b) => hostSales[b].omzet - hostSales[a].omzet);
        const tbody = salesReportTopHostTable;
        tbody.innerHTML = '';

        if (sortedHosts.length === 0) {
            tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-sm text-gray-400">Tidak ada data.</td></tr>`;
            return;
        }

        sortedHosts.forEach(host => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="py-2 px-3 text-sm font-medium text-gray-900">${host}</td>
                <td class="py-2 px-3 text-sm text-gray-500">${formatCurrency(hostSales[host].omzet)}</td>
                <td class="py-2 px-3 text-sm text-gray-500">${hostSales[host].pcs.toLocaleString('id-ID')}</td>
            `;
            tbody.appendChild(tr);
        });
    }


    function populateFilters() {
        const getUniqueValues = (key) => [...new Set(allData.map(item => item[key]).filter(Boolean))];
        const dashboardFilterShift = document.getElementById('dashboardFilterShift');
        const dashboardFilterHost = document.getElementById('dashboardFilterHost');
        const dashboardFilterAdmin = document.getElementById('dashboardFilterAdmin');
        populateDropdown(dashboardFilterShift, getUniqueValues('Shift'), false);
        populateDropdown(dashboardFilterHost, getUniqueValues('Nama Host'), false);
        populateDropdown(dashboardFilterAdmin, getUniqueValues('Nama Admin'), false);
    }
    
    function setupForm(formId, type, formFields) {
        const form = document.getElementById(formId);
        
        formFields.omzet?.addEventListener('input', (e) => { e.target.value = formatCurrency(parseCurrency(e.target.value)); });
        
        if (formFields.host) formFields.host.onchange = () => { formFields.backupHostContainer?.classList.toggle('hidden', formFields.host.value !== 'Backup'); };
        if (formFields.admin) formFields.admin.onchange = () => { formFields.backupAdminContainer?.classList.toggle('hidden', formFields.admin.value !== 'Backup'); };
        if (formFields.treatment) formFields.treatment.onchange = () => { formFields.backupTreatmentContainer?.classList.toggle('hidden', formFields.treatment.value !== 'Backup'); };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!form.checkValidity()) {
                form.querySelector(':invalid')?.focus();
                formFields.status.textContent = 'Error: Mohon isi semua kolom.';
                formFields.status.className = 'mt-4 text-center text-sm h-4 text-red-600';
                return;
            }
            formFields.status.textContent = '';
            const submitBtn = document.getElementById(formFields.submitBtnId);
            const btnText = submitBtn.querySelector('span');
            const loader = submitBtn.querySelector('.loader');
            
            const customerName = formFields.customer?.value.trim();
            if (customerName && ['Penjualan', 'Return'].includes(type)) {
                if (checkDuplicateCustomerToday(customerName, type)) {
                    const confirmSend = window.confirm(`Peringatan: Nama pelanggan "${customerName}" untuk transaksi ${type} sudah terinput di hari ini. Lanjutkan pengiriman?`);
                    if (!confirmSend) {
                        formFields.status.textContent = 'Pengiriman dibatalkan.';
                        formFields.status.className = 'mt-4 text-center text-sm h-4 text-gray-600';
                        return;
                    }
                }
            }

            btnText.classList.add('hidden'); loader.classList.remove('hidden'); submitBtn.disabled = true;

            const finalHost = formFields.host?.value === 'Backup' ? formFields.backupHostInput?.value.trim() : formFields.host?.value;
            const finalAdmin = formFields.admin?.value === 'Backup' ? formFields.backupAdminInput?.value.trim() : formFields.admin?.value;
            const finalTreatment = formFields.treatment?.value === 'Backup' ? formFields.backupTreatmentInput?.value.trim() : formFields.treatment?.value;

            const omzetValue = parseCurrency(formFields.omzet?.value);
            const formData = {
                action: 'add',
                transactionType: type,
                shift: formFields.shift?.value || '',
                host: finalHost || '',
                adminName: finalAdmin || '',
                customerName: customerName || '',
                totalPcs: formFields.pcs?.value || '',
                totalOmzet: omzetValue || '',
                orangTreatment: finalTreatment || '',
                pcsTreatment: formFields.pcsTreatment?.value || '',
            };
            
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(formData) });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                formFields.status.textContent = `Laporan ${type} berhasil dikirim!`;
                formFields.status.className = 'mt-4 text-center text-sm h-4 text-green-600';
                form.reset();
                if (formFields.backupHostContainer) formFields.backupHostContainer.classList.add('hidden');
                if (formFields.backupAdminContainer) formFields.backupAdminContainer.classList.add('hidden');
                if (formFields.backupTreatmentContainer) formFields.backupTreatmentContainer.classList.add('hidden');
                isDataFetched = false;
            } catch (error) {
                formFields.status.textContent = `Error: ${error.message}`;
                formFields.status.className = 'mt-4 text-center text-sm h-4 text-red-600';
            } finally {
                btnText.classList.remove('hidden'); loader.classList.add('hidden'); submitBtn.disabled = false;
            }
        });
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        openSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
        });
        [closeSidebarBtn, sidebarOverlay].forEach(el => el.addEventListener('click', closeSidebar));
        
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.dataset.page;
                if (pageId === 'salesReportPage') {
                    salesReportPasswordModal.classList.remove('hidden');
                    salesReportPasswordModal.classList.add('flex');
                    salesReportPasswordInput.focus();
                } else {
                    switchPage(pageId);
                }
            });
        });

        populateDropdown(document.getElementById('penjualanHost'), hostList);
        populateDropdown(document.getElementById('penjualanAdmin'), adminList);
        populateDropdown(document.getElementById('returnHost'), hostList);
        populateDropdown(document.getElementById('returnAdmin'), adminList);
        populateDropdown(document.getElementById('treatmentPerson'), treatmentPersonList);

        populateDropdown(editHostInput, hostList);
        populateDropdown(editAdminInput, adminList);
        populateDropdown(editOrangTreatmentInput, treatmentPersonList);

        setupForm('penjualanForm', 'Penjualan', {
             shift: document.getElementById('penjualanShift'), host: document.getElementById('penjualanHost'), admin: document.getElementById('penjualanAdmin'), customer: document.getElementById('penjualanCustomer'), pcs: document.getElementById('penjualanPcs'), omzet: document.getElementById('penjualanOmzet'),
             backupHostContainer: document.getElementById('penjualanBackupHostContainer'), backupAdminContainer: document.getElementById('penjualanBackupAdminContainer'),
             backupHostInput: document.getElementById('penjualanBackupHost'), backupAdminInput: document.getElementById('penjualanBackupAdmin'),
             submitBtnId: 'penjualanSubmitBtn', status: document.getElementById('penjualanStatus'),
        });
        
        setupForm('returnForm', 'Return', {
             host: document.getElementById('returnHost'), admin: document.getElementById('returnAdmin'), customer: document.getElementById('returnCustomer'), pcs: document.getElementById('returnPcs'), omzet: document.getElementById('returnOmzet'),
             backupHostContainer: document.getElementById('returnBackupHostContainer'), backupAdminContainer: document.getElementById('returnBackupAdminContainer'),
             backupHostInput: document.getElementById('returnBackupHost'), backupAdminInput: document.getElementById('returnBackupAdmin'),
             submitBtnId: 'returnSubmitBtn', status: document.getElementById('returnStatus'),
        });

        setupForm('treatmentForm', 'Treatment', {
             treatment: document.getElementById('treatmentPerson'), pcsTreatment: document.getElementById('treatmentPcs'),
             backupTreatmentContainer: document.getElementById('treatmentBackupContainer'), backupTreatmentInput: document.getElementById('treatmentBackupPerson'),
             submitBtnId: 'treatmentSubmitBtn', status: document.getElementById('treatmentStatus'),
        });
        
        const litepickerOptions = {
            singleMode: false, format: 'DD MMM YY', lang: 'id-ID', numberOfMonths: 2,
            dropdowns: { minYear: 2020, maxYear: null, months: true, years: true },
            buttonText: {
                'previousMonth': `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>`,
                'nextMonth': `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>`,
            },
        };

        dashboardDatePicker = new Litepicker({ element: document.getElementById('dashboardDateRangePicker'), ...litepickerOptions, setup: (picker) => { picker.on('selected', () => applyFilters()); }});
        customerDatePicker = new Litepicker({ element: document.getElementById('customerReportDateRangePicker'), ...litepickerOptions, setup: (picker) => { picker.on('selected', () => applyCustomerReportFilters()); }});
        salesReportDatePicker = new Litepicker({ element: document.getElementById('salesReportDateRangePicker'), ...litepickerOptions, setup: (picker) => { picker.on('selected', () => applySalesReportFilters()); }});

        ['input', 'change'].forEach(evt => {
            document.getElementById('dashboardSearchCustomer').addEventListener(evt, applyFilters);
            document.getElementById('dashboardFilterShift').addEventListener(evt, applyFilters);
            document.getElementById('dashboardFilterHost').addEventListener(evt, applyFilters);
            document.getElementById('dashboardFilterAdmin').addEventListener(evt, applyFilters);
            document.getElementById('dashboardFilterTransactionType').addEventListener(evt, applyFilters); // NEW listener
        });
        
        salesReportDatePicker.on('selected', () => applySalesReportFilters());

        // Event listeners for pagination buttons
        prevPageBtn.addEventListener('click', () => changePage('prev'));
        nextPageBtn.addEventListener('click', () => changePage('next'));

        // NEW: Event listener for Export Excel button
        exportExcelBtn.addEventListener('click', exportDashboardToExcel);

        pinInputs[0].focus();
    });
    </script>
</body>
</html>
